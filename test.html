<!doctype html>
<html>
  <head>
    <title>Infinite scroll test</title>
  </head>
  <body>
    <div id='project-scroller'></div>
    <button id='scroll-left'>&lt;--</button>
    <button id='scroll-right'>--&gt;</button>
    <style>
      #project-scroller {
        display: flex;
        flex-direction: row;
        width: 600px;
        overflow-x: scroll;
        position: relative;

        /* hide scrollbar */
        -ms-overflow-style: none;
        overflow: -moz-scrollbars-none;
      }
      #project-scroller::-webkit-scrollbar {
        display: none;
      }
      .project-icon {
        flex: 0 0 132px;
        width: 132px;
        height: 132px;
        /*background-color: darkgrey;*/
        margin: 0px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .project-icon > img {
        width: 50px;
        height: 50px;
        border-radius: 0.5em;
        box-shadow: 0 0 1px 1px lightgrey;
        transition: width 0.2s, height 0.2s;
      }
      .project-icon.centered > img {
        width: 128px;
        height: 128px;
      }
    </style>
    <script>
      let scrollContainer = document.querySelector('#project-scroller');
      let data = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];
      data.forEach((datum, index) => {
        let div = document.createElement('div');
        div.classList.add('project-icon');
        div.dataset.index = index;
        /*let color = Math.floor(Math.random() * Math.pow(16, 6));
        div.style.backgroundColor = '#' + color.toString(16);*/
        let image = document.createElement('img');
        image.src = './assets/bb.jpg';
        div.appendChild(image);
        scrollContainer.appendChild(div);
      });

      let n = data.length;
      let cur = Math.floor(n / 2);

      // set to center
      let sampleElement = scrollContainer.firstChild;
      let sampleElementWidth = sampleElement.offsetWidth + parseInt(getComputedStyle(sampleElement).marginLeft.slice(0, -2)) * 2;
      scrollContainer.scrollLeft = (sampleElementWidth * (n - (n % 2 - 1)) - scrollContainer.offsetWidth) / 2;

      let getCenterItem = _ => {
        let scrollPos = scrollContainer.scrollLeft;
        let containerCenter = scrollContainer.offsetWidth / 2;
        let sampleElement = scrollContainer.firstChild;
        let elementWidth = sampleElement.offsetWidth;
        let elementMargin = parseInt(getComputedStyle(sampleElement).marginLeft.slice(0, -2));
        let closest, closestElem;
        document.querySelectorAll('.project-icon').forEach((icon, index) => {
          let iconOffset = icon.offsetLeft + elementWidth / 2 - scrollPos;
          if(Math.abs(iconOffset - containerCenter) <= elementWidth / 2 + elementMargin) {
            // closest to center!
            icon.classList.add('centered');
            closest = index;
            closestElem = icon;
          } else {
            // not closest to center
            icon.classList.remove('centered');
          }
        });
        return {
          index: closest,
          elem: closestElem
        };
      };

      // debouncing
      let debounceTimeout;
      let autoplayInterval;
      debounceScrollHandler = _ => {
        if(throttleLock) return;
        let closestElem = getCenterItem().elem;
        throttleLock = true;
        let scrollToPos = closestElem.offsetLeft + (sampleElementWidth - scrollContainer.offsetWidth) / 2;
        if(scrollToPos != scrollContainer.scrollLeft) {
          clearInterval(autoplayInterval);
        }
        scrollContainer.scrollTo({
          left: scrollToPos,
          behavior: 'smooth'
        });
        setTimeout(_ => {
          throttleLock = false;
        }, 500);
      };

      // main scroll handler
      let throttleLock = false;
      let scrollHandler = _ => {
        if(throttleLock) return;
        throttleLock = true;

        let closest = getCenterItem();
        let ind = closest.index;
        let elem = closest.elem;
        if(elem.dataset.index != cur) {
          cur = elem.dataset.index;
          console.log('changed! cur = ' + cur);
        }

        let left = ind;
        let right = n - 1 - ind;
        let diff = right - left;

        if((n % 2 == 0 && Math.abs(diff) > 2) || (n % 2 == 1 && Math.abs(diff) > 0)) {
          if(diff < 0) {
            // more on left than right
            for(let i = 0; i < -diff / 2; i++) {
              /* maintaining scroll position picked up from https://codepen.io/ArtemGordinsky/pen/CevBD */
              let currentOffset = scrollContainer.lastChild.offsetLeft - scrollContainer.scrollLeft;
              scrollContainer.appendChild(scrollContainer.removeChild(scrollContainer.firstChild));
              scrollContainer.scrollLeft = scrollContainer.lastChild.previousSibling.offsetLeft - currentOffset;
            }
          } else {
            // more on right than left
            for(let i = 0; i < diff / 2; i++) {
              let currentOffset = scrollContainer.firstChild.offsetLeft - scrollContainer.scrollLeft;
              scrollContainer.insertBefore(scrollContainer.removeChild(scrollContainer.lastChild), scrollContainer.firstChild);
              scrollContainer.scrollLeft = scrollContainer.firstChild.nextSibling.offsetLeft - currentOffset;
            }
          }
          
        }

        // switch to this for primitive throttling
        //setTimeout(_ => throttleLock = false, 50);

        throttleLock = false;
      };
      scrollContainer.addEventListener('scroll', _ => {
        scrollHandler();

        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(debounceScrollHandler, 500);
      });

      // autoplay while pristine
      autoplayInterval = setInterval(_ => {
        if(throttleLock) return;
        throttleLock = true;
        scrollContainer.scrollBy({
          left: sampleElementWidth,
          behavior: 'smooth'
        });
        setTimeout(_ => {
          throttleLock = false;
          scrollHandler();
        }, 500);
      }, 5000);

      // scroll left and right
      let scrollAmount = Math.round(scrollContainer.offsetWidth / sampleElementWidth) * sampleElementWidth;
      let scrollButtonHandler = left => {
        if(throttleLock) return;
        clearInterval(autoplayInterval);
        throttleLock = true;
        scrollContainer.scrollBy({
          left: scrollAmount * (left ? -1 : 1),
          behavior: 'smooth'
        });
        setTimeout(_ => {
          throttleLock = false;
          scrollHandler();
        }, 500);
      };
      document.querySelector('#scroll-left').addEventListener('click', scrollButtonHandler.bind(null, true));
      document.querySelector('#scroll-right').addEventListener('click', scrollButtonHandler.bind(null, false));
      
    </script>
  </body>
</html>
